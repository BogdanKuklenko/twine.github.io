window.storyFormat({
  name: "NovaWeave",
  version: "1.0.0",
  author: "Custom Engine",
  description: "\u042d\u043a\u0441\u043f\u0435\u0440\u0438\u043c\u0435\u043d\u0442\u0430\u043b\u044c\u043d\u044b\u0439 \u0444\u043e\u0440\u043c\u0430\u0442 \u0434\u043b\u044f Twine \u0441 \u0440\u0430\u0441\u0448\u0438\u0440\u0435\u043d\u043d\u044b\u043c\u0438 \u043c\u0430\u043a\u0440\u043e\u0441\u0430\u043c\u0438, \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u0435\u043c \u0438 \u043f\u0430\u043d\u0435\u043b\u044f\u043c\u0438 \u0430\u043d\u0430\u043b\u0438\u0442\u0438\u043a\u0438.",
  image: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0nMTI4JyBoZWlnaHQ9JzEyOCcgdmlld0JveD0nMCAwIDEyOCAxMjgnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zyc+PHJhZGlhbEdyYWRpZW50IGlkPSdnJyBjeD0nNjQnIGN5PSc2NCcgcj0nNjQnPjxzdG9wIHJvZmY9JzAnIHN0b3AtY29sb3I9JyMzMjgzZicsIHN0b3Atb3BhY2l0eT0nMC45Jy8+PHN0b3Agcm9mZj0nMScgc3RvcC1jb2xvcj0nIzBiMTk0ZScgc3RvcC1vcGFjaXR5PScwLjgnLz48L3JhZGlhbEdyYWRpZW50PjxjaXJjbGUgY3g9JzY0JyBjeT0nNjQnIHI9JzYzJyBmaWxsPSd1cmwoI2cpJy8+PHBhdGggZD0nTTY0IDRsMTUgMzZsMzcuNSA1LjUtMjguNSAyNSAyLjUgMzkuNS0yNi00Mi0zNC40IDI2LjUgOC4xLTM0LjV6JyBmaWxsPScjZmZmJyBvcGFjaXR5PScwLjcnLz48L3N2Zz4=",
  proofing: false,
  license: "MIT",
  url: "https://twine.github.io/",
  source: "<!DOCTYPE html>\n<html lang=\"ru\">\n<head>\n<meta charset=\"utf-8\">\n<title>{{STORY_NAME}}</title>\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n<style>\n  :root {\n    color-scheme: dark;\n    --nw-bg: radial-gradient(circle at top, #070b1c 0%, #05060d 60%, #02030a 100%);\n    --nw-panel-bg: rgba(14, 22, 42, 0.85);\n    --nw-panel-border: rgba(121, 162, 255, 0.35);\n    --nw-text: #f4f8ff;\n    --nw-muted: rgba(215, 229, 255, 0.68);\n    --nw-accent: #89c7ff;\n    --nw-accent-strong: #ffd166;\n    --nw-danger: #ff6b6b;\n    --nw-success: #59f2c8;\n    --nw-mono: 'Fira Code', 'JetBrains Mono', Consolas, monospace;\n    --nw-serif: 'Merriweather', 'Georgia', serif;\n    --nw-transition: 240ms cubic-bezier(0.33, 1, 0.68, 1);\n  }\n\n  body.nw-body {\n    margin: 0;\n    min-height: 100vh;\n    background: var(--nw-bg);\n    color: var(--nw-text);\n    font-family: \"Inter\", \"Segoe UI\", \"SF Pro Display\", sans-serif;\n    display: flex;\n    justify-content: center;\n    align-items: stretch;\n    padding: 2.5rem 1.5rem 3rem;\n    box-sizing: border-box;\n  }\n\n  .nw-app {\n    display: grid;\n    grid-template-columns: minmax(0, 1fr);\n    grid-template-rows: auto auto 1fr;\n    gap: 1.25rem;\n    width: min(64rem, 100%);\n    background: var(--nw-panel-bg);\n    border: 1px solid var(--nw-panel-border);\n    border-radius: 1.5rem;\n    padding: 1.75rem 2rem 2.25rem;\n    box-shadow: 0 28px 55px rgba(0, 0, 0, 0.45);\n    backdrop-filter: blur(16px);\n    position: relative;\n  }\n\n  .nw-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    gap: 1.5rem;\n  }\n\n  .nw-title {\n    font-family: var(--nw-serif);\n    font-size: clamp(1.5rem, 3vw, 2.3rem);\n    letter-spacing: 0.08em;\n    text-transform: uppercase;\n    color: var(--nw-accent);\n    text-shadow: 0 0 22px rgba(137, 199, 255, 0.55);\n  }\n\n  .nw-controls {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 0.6rem;\n  }\n\n  .nw-button {\n    background: rgba(16, 30, 58, 0.85);\n    color: var(--nw-text);\n    border: 1px solid rgba(137, 199, 255, 0.35);\n    border-radius: 999px;\n    padding: 0.45rem 1.1rem;\n    font-size: 0.85rem;\n    letter-spacing: 0.04em;\n    text-transform: uppercase;\n    cursor: pointer;\n    transition: transform var(--nw-transition), background var(--nw-transition), border-color var(--nw-transition);\n  }\n\n  .nw-button:hover,\n  .nw-button:focus-visible {\n    outline: none;\n    background: rgba(137, 199, 255, 0.2);\n    border-color: rgba(137, 199, 255, 0.65);\n    transform: translateY(-1px);\n  }\n\n  .nw-button[data-active=\"true\"] {\n    background: rgba(137, 199, 255, 0.35);\n    border-color: rgba(137, 199, 255, 0.85);\n    color: #0c101c;\n  }\n\n  .nw-panels {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(16rem, 1fr));\n    gap: 1rem;\n  }\n\n  .nw-panel {\n    background: rgba(5, 9, 22, 0.78);\n    border: 1px solid rgba(255, 255, 255, 0.05);\n    border-radius: 1.1rem;\n    padding: 1rem 1.1rem 1.2rem;\n    max-height: 14.5rem;\n    overflow: auto;\n    transition: opacity var(--nw-transition), transform var(--nw-transition);\n  }\n\n  .nw-panel[hidden] {\n    display: none;\n  }\n\n  .nw-panel h2 {\n    margin-top: 0;\n    margin-bottom: 0.75rem;\n    font-size: 0.95rem;\n    letter-spacing: 0.08em;\n    text-transform: uppercase;\n    color: var(--nw-muted);\n  }\n\n  .nw-main {\n    background: rgba(7, 12, 28, 0.92);\n    border: 1px solid rgba(137, 199, 255, 0.25);\n    border-radius: 1.2rem;\n    padding: clamp(1.5rem, 3vw, 2.4rem);\n    min-height: 18rem;\n    box-shadow: inset 0 0 25px rgba(0, 0, 0, 0.25);\n    position: relative;\n    overflow: hidden;\n  }\n\n  .nw-passage {\n    animation: nw-fade-in 420ms ease;\n  }\n\n  @keyframes nw-fade-in {\n    from { opacity: 0; transform: translateY(6px); }\n    to { opacity: 1; transform: translateY(0); }\n  }\n\n  .nw-passage p {\n    line-height: 1.75;\n    margin-top: 0;\n    margin-bottom: 1.2rem;\n  }\n\n  .nw-passage p:last-child {\n    margin-bottom: 0;\n  }\n\n  .nw-link,\n  .nw-choice {\n    color: var(--nw-accent-strong);\n    font-weight: 600;\n    border-bottom: 1px dashed rgba(255, 209, 102, 0.45);\n    cursor: pointer;\n    transition: color var(--nw-transition), border-color var(--nw-transition);\n    text-decoration: none;\n  }\n\n  .nw-choice {\n    background: transparent;\n    border: none;\n    padding: 0;\n    font: inherit;\n  }\n\n  .nw-link:hover,\n  .nw-choice:hover,\n  .nw-link:focus-visible,\n  .nw-choice:focus-visible {\n    color: var(--nw-success);\n    border-bottom-color: rgba(89, 242, 200, 0.55);\n    outline: none;\n  }\n\n  .nw-history-entry {\n    border-bottom: 1px solid rgba(137, 199, 255, 0.15);\n    padding: 0.35rem 0 0.55rem;\n  }\n\n  .nw-history-entry:last-child {\n    border-bottom: none;\n  }\n\n  .nw-history-entry time {\n    font-size: 0.78rem;\n    color: var(--nw-muted);\n  }\n\n  .nw-note {\n    margin-top: 0.4rem;\n    padding-left: 0.75rem;\n    border-left: 2px solid rgba(137, 199, 255, 0.3);\n    font-style: italic;\n    font-size: 0.85rem;\n  }\n\n  .nw-tag {\n    display: inline-flex;\n    align-items: center;\n    justify-content: center;\n    padding: 0.1rem 0.45rem;\n    margin-right: 0.35rem;\n    border-radius: 999px;\n    background: rgba(137, 199, 255, 0.18);\n    border: 1px solid rgba(137, 199, 255, 0.35);\n    font-size: 0.72rem;\n    letter-spacing: 0.06em;\n    text-transform: uppercase;\n    color: var(--nw-muted);\n  }\n\n  .nw-state-entry {\n    display: flex;\n    justify-content: space-between;\n    gap: 0.75rem;\n    font-family: var(--nw-mono);\n    font-size: 0.85rem;\n    padding: 0.25rem 0;\n    border-bottom: 1px dotted rgba(137, 199, 255, 0.15);\n  }\n\n  .nw-state-entry:last-child {\n    border-bottom: none;\n  }\n\n  .nw-meter {\n    margin: 0.9rem 0 1.1rem;\n  }\n\n  .nw-meter-label {\n    display: flex;\n    justify-content: space-between;\n    font-size: 0.82rem;\n    letter-spacing: 0.05em;\n    text-transform: uppercase;\n    color: var(--nw-muted);\n    margin-bottom: 0.35rem;\n  }\n\n  .nw-meter-bar {\n    position: relative;\n    height: 0.55rem;\n    border-radius: 999px;\n    overflow: hidden;\n    background: rgba(137, 199, 255, 0.15);\n  }\n\n  .nw-meter-fill {\n    position: absolute;\n    inset: 0;\n    border-radius: inherit;\n    background: var(--nw-meter-accent, linear-gradient(90deg, rgba(137, 199, 255, 0.75), rgba(255, 209, 102, 0.65)));\n    transition: width 320ms ease;\n  }\n\n  .nw-loader {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    justify-content: center;\n    gap: 1rem;\n    color: var(--nw-muted);\n    font-size: 0.95rem;\n    letter-spacing: 0.08em;\n    text-transform: uppercase;\n  }\n\n  .nw-spinner {\n    width: 3.5rem;\n    height: 3.5rem;\n    border-radius: 50%;\n    border: 3px solid rgba(137, 199, 255, 0.18);\n    border-top-color: rgba(255, 209, 102, 0.85);\n    animation: nw-spin 1s linear infinite;\n  }\n\n  @keyframes nw-spin {\n    to { transform: rotate(360deg); }\n  }\n\n  body[data-passage-tags~=\"danger\"] .nw-main {\n    box-shadow: inset 0 0 28px rgba(255, 107, 107, 0.25);\n  }\n\n  body[data-passage-tags~=\"calm\"] .nw-main {\n    box-shadow: inset 0 0 28px rgba(89, 242, 200, 0.25);\n  }\n\n  .nw-warning {\n    border: 1px solid rgba(255, 209, 102, 0.45);\n    background: rgba(255, 209, 102, 0.12);\n    color: #fef6d8;\n    padding: 0.75rem 1rem;\n    border-radius: 0.75rem;\n    margin: 1rem 0;\n  }\n\n  .nw-log-line {\n    font-family: var(--nw-mono);\n    font-size: 0.78rem;\n    padding: 0.2rem 0;\n    border-bottom: 1px dotted rgba(137, 199, 255, 0.15);\n  }\n\n  .nw-empty {\n    font-size: 0.85rem;\n    color: var(--nw-muted);\n    font-style: italic;\n  }\n\n  @media (max-width: 960px) {\n    body.nw-body {\n      padding: 1.5rem;\n    }\n\n    .nw-app {\n      padding: 1.25rem 1.4rem 1.75rem;\n    }\n\n    .nw-panels {\n      grid-template-columns: 1fr;\n    }\n  }\n\n  @media (prefers-reduced-motion: reduce) {\n    *, *::before, *::after {\n      animation-duration: 0.01ms !important;\n      animation-iteration-count: 1 !important;\n      transition-duration: 0.01ms !important;\n      scroll-behavior: auto !important;\n    }\n  }\n</style>\n<style id=\"story-user-style\">\n{{STORY_STYLESHEET}}\n</style>\n</head>\n<body class=\"nw-body\">\n<div id=\"nova-app\" class=\"nw-app\" hidden>\n  <header class=\"nw-header\">\n    <div class=\"nw-title\"></div>\n    <div class=\"nw-controls\">\n      <button class=\"nw-button\" data-panel=\"history\">\u0425\u0440\u043e\u043d\u0438\u043a\u0430</button>\n      <button class=\"nw-button\" data-panel=\"state\">\u041f\u0435\u0440\u0435\u043c\u0435\u043d\u043d\u044b\u0435</button>\n      <button class=\"nw-button\" data-panel=\"log\">\u0416\u0443\u0440\u043d\u0430\u043b</button>\n      <button class=\"nw-button\" data-action=\"restart\">\u0421\u0431\u0440\u043e\u0441</button>\n    </div>\n  </header>\n  <section class=\"nw-panels\">\n    <div class=\"nw-panel\" data-panel-name=\"history\" hidden>\n      <h2>\u0425\u043e\u0434 \u0438\u0441\u0442\u043e\u0440\u0438\u0438</h2>\n      <div class=\"nw-history\"></div>\n    </div>\n    <div class=\"nw-panel\" data-panel-name=\"state\" hidden>\n      <h2>\u041f\u0435\u0440\u0435\u043c\u0435\u043d\u043d\u044b\u0435</h2>\n      <div class=\"nw-state\"></div>\n    </div>\n    <div class=\"nw-panel\" data-panel-name=\"log\" hidden>\n      <h2>\u0421\u0438\u0441\u0442\u0435\u043c\u043d\u044b\u0439 \u0436\u0443\u0440\u043d\u0430\u043b</h2>\n      <div class=\"nw-log\"></div>\n    </div>\n  </section>\n  <main id=\"nova-main\" class=\"nw-main\"></main>\n</div>\n<div id=\"nova-loader\" class=\"nw-loader\">\n  <div class=\"nw-spinner\"></div>\n  <p>\u0418\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u044f NovaWeave...</p>\n</div>\n{{STORY_DATA}}\n<script>\n(() => {\n  \"use strict\";\n\n  function escapeHtml(value) {\n    return String(value)\n      .replace(/&/g, \"&amp;\")\n      .replace(/</g, \"&lt;\")\n      .replace(/>/g, \"&gt;\")\n      .replace(/\"/g, \"&quot;\")\n      .replace(/'/g, \"&#39;\");\n  }\n\n  const BACKTICK = String.fromCharCode(96);\n\n  function escapeAttribute(value) {\n    return escapeHtml(value).split(BACKTICK).join(\"&#96;\");\n  }\n\n  function safeString(value) {\n    if (value === null || value === undefined) {\n      return \"\";\n    }\n    if (typeof value === \"number\" && !Number.isFinite(value)) {\n      return \"\";\n    }\n    return String(value);\n  }\n\n  const storyElement = document.querySelector(\"tw-storydata\");\n  if (!storyElement) {\n    console.error(\"[NovaWeave] \u041d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d \u044d\u043b\u0435\u043c\u0435\u043d\u0442 tw-storydata.\");\n    return;\n  }\n\n  const app = document.getElementById(\"nova-app\");\n  const main = document.getElementById(\"nova-main\");\n  const loader = document.getElementById(\"nova-loader\");\n  const titleElement = app.querySelector(\".nw-title\");\n  const historyContainer = app.querySelector(\".nw-history\");\n  const stateContainer = app.querySelector(\".nw-state\");\n  const logContainer = app.querySelector(\".nw-log\");\n\n  const storyName = storyElement.getAttribute(\"name\") || \"Twine Story\";\n  const ifid = storyElement.getAttribute(\"ifid\") || \"IFID-UNKNOWN\";\n  const startNodeId = storyElement.getAttribute(\"startnode\");\n  const formatName = storyElement.getAttribute(\"format\") || \"unknown\";\n  const formatVersion = storyElement.getAttribute(\"format-version\") || \"0\";\n\n  document.title = storyName;\n  titleElement.textContent = storyName;\n\n  const rawPassages = Array.from(storyElement.querySelectorAll(\"tw-passagedata\"));\n  const idToName = new Map();\n  rawPassages.forEach(p => {\n    idToName.set(p.getAttribute(\"pid\"), p.getAttribute(\"name\"));\n  });\n  const startPassageName = idToName.get(startNodeId);\n\n  const storageKey = `NovaWeave::${ifid}`;\n  const rawVars = Object.create(null);\n  const state = {\n    current: null,\n    history: [],\n    notesPerPassage: new Map(),\n    metadata: {\n      name: storyName,\n      ifid,\n      formatName,\n      formatVersion,\n      totalPassages: rawPassages.length\n    },\n    get vars() {\n      return varsProxy;\n    }\n  };\n\n  let persistHandle = null;\n  function schedulePersist() {\n    if (persistHandle !== null) {\n      return;\n    }\n    const scheduler = window.requestAnimationFrame || (callback => setTimeout(callback, 16));\n    persistHandle = scheduler(() => {\n      persistHandle = null;\n      persistState();\n    });\n  }\n\n  function cloneLocals(locals) {\n    const result = Object.create(null);\n    let source = locals;\n    while (source) {\n      Object.getOwnPropertyNames(source).forEach(key => {\n        if (!(key in result)) {\n          result[key] = source[key];\n        }\n      });\n      source = Object.getPrototypeOf(source);\n    }\n    return result;\n  }\n\n  const varsProxy = new Proxy(rawVars, {\n    set(target, prop, value) {\n      target[prop] = value;\n      renderStatePanel();\n      schedulePersist();\n      return true;\n    },\n    deleteProperty(target, prop) {\n      delete target[prop];\n      renderStatePanel();\n      schedulePersist();\n      return true;\n    }\n  });\n\n  const logLines = [];\n  function pushLog(message) {\n    const stamp = new Date().toLocaleTimeString();\n    const entry = `[${stamp}] ${message}`;\n    logLines.push(entry);\n    if (logLines.length > 240) {\n      logLines.shift();\n    }\n    renderLog();\n    console.info(\"[NovaWeave]\", message);\n  }\n\n  function renderLog() {\n    if (!logContainer) {\n      return;\n    }\n    if (!logLines.length) {\n      logContainer.innerHTML = '<p class=\"nw-empty\">\u0416\u0443\u0440\u043d\u0430\u043b \u043f\u0443\u0441\u0442.</p>';\n      return;\n    }\n    logContainer.innerHTML = logLines\n      .map(line => `<div class=\"nw-log-line\">${escapeHtml(line)}</div>`)\n      .join(\"\");\n  }\n\n  const util = {\n    random(min = 0, max = 1, step = 1) {\n      if (max < min) {\n        [min, max] = [max, min];\n      }\n      const steps = Math.floor((max - min) / step);\n      const value = min + Math.floor(Math.random() * (steps + 1)) * step;\n      return Number(value.toFixed(12));\n    },\n    pick(collection) {\n      if (!collection) {\n        return null;\n      }\n      const arr = Array.isArray(collection) ? collection : Object.values(collection);\n      if (!arr.length) {\n        return null;\n      }\n      return arr[Math.floor(Math.random() * arr.length)];\n    },\n    clamp(value, min, max) {\n      return Math.min(Math.max(value, min), max);\n    },\n    now() {\n      return Date.now();\n    },\n    iso(timestamp = Date.now()) {\n      return new Date(timestamp).toISOString();\n    },\n    time(timestamp = Date.now()) {\n      return new Date(timestamp).toLocaleTimeString();\n    },\n    date(timestamp = Date.now()) {\n      return new Date(timestamp).toLocaleDateString();\n    },\n    capitalize(text = \"\") {\n      return safeString(text).replace(/^(.)/, (m, ch) => ch.toUpperCase());\n    },\n    words(text = \"\") {\n      return safeString(text).trim().split(/\\s+/);\n    }\n  };\n\n  let compiledPassages = new Map();\n  let paletteKeys = new Set();\n\n  function tokenize(content) {\n    const tokens = [];\n    let index = 0;\n    while (index < content.length) {\n      const macroStart = content.indexOf(\"<<\", index);\n      if (macroStart === -1) {\n        tokens.push({ type: \"text\", value: content.slice(index) });\n        break;\n      }\n      if (macroStart > index) {\n        tokens.push({ type: \"text\", value: content.slice(index, macroStart) });\n      }\n      let depth = 1;\n      let searchIndex = macroStart + 2;\n      let macroEnd = -1;\n      while (searchIndex < content.length) {\n        const closeIndex = content.indexOf(\">>\", searchIndex);\n        if (closeIndex === -1) {\n          break;\n        }\n        macroEnd = closeIndex;\n        break;\n      }\n      if (macroEnd === -1) {\n        tokens.push({ type: \"text\", value: content.slice(macroStart) });\n        break;\n      }\n      const macroBody = content.slice(macroStart + 2, macroEnd).trim();\n      tokens.push({ type: \"macro\", value: macroBody });\n      index = macroEnd + 2;\n    }\n    return tokens;\n  }\n\n  function parseTokens(tokens) {\n    const root = { type: \"root\", children: [] };\n    const stack = [{ node: root, children: root.children }];\n\n    function currentFrame() {\n      return stack[stack.length - 1];\n    }\n\n    for (const token of tokens) {\n      if (token.type === \"text\") {\n        currentFrame().children.push({ type: \"text\", value: token.value });\n        continue;\n      }\n\n      const body = token.value;\n      if (!body) {\n        continue;\n      }\n      const firstSpace = body.indexOf(\" \");\n      const keyword = (firstSpace === -1 ? body : body.slice(0, firstSpace)).trim();\n      const argString = firstSpace === -1 ? \"\" : body.slice(firstSpace + 1).trim();\n\n      if (keyword.startsWith(\"/\")) {\n        const closing = keyword.slice(1);\n        if (closing === \"if\" || closing === \"for\") {\n          stack.pop();\n        }\n        continue;\n      }\n\n      switch (keyword) {\n        case \"if\": {\n          const node = { type: \"if\", branches: [{ condition: argString, children: [] }] };\n          currentFrame().children.push(node);\n          stack.push({ node, children: node.branches[0].children });\n          break;\n        }\n        case \"elseif\": {\n          const frame = currentFrame();\n          if (frame.node && frame.node.type === \"if\") {\n            const branch = { condition: argString, children: [] };\n            frame.node.branches.push(branch);\n            frame.children = branch.children;\n          }\n          break;\n        }\n        case \"else\": {\n          const frame = currentFrame();\n          if (frame.node && frame.node.type === \"if\") {\n            const branch = { condition: null, children: [] };\n            frame.node.branches.push(branch);\n            frame.children = branch.children;\n          }\n          break;\n        }\n        case \"for\": {\n          const node = { type: \"for\", expression: argString, children: [], variable: null };\n          const match = argString.match(/^(\\S+)\\s+over\\s+(.+)$/i);\n          if (match) {\n            node.variable = match[1];\n            node.expression = match[2];\n          }\n          currentFrame().children.push(node);\n          stack.push({ node, children: node.children });\n          break;\n        }\n        case \"set\": {\n          currentFrame().children.push({ type: \"set\", code: argString });\n          break;\n        }\n        case \"print\": {\n          currentFrame().children.push({ type: \"print\", expression: argString });\n          break;\n        }\n        case \"display\": {\n          currentFrame().children.push({ type: \"display\", target: argString });\n          break;\n        }\n        case \"choice\": {\n          currentFrame().children.push(parseChoiceMacro(argString));\n          break;\n        }\n        case \"timer\": {\n          currentFrame().children.push(parseTimerMacro(argString));\n          break;\n        }\n        case \"remember\": {\n          currentFrame().children.push({ type: \"remember\", expression: argString });\n          break;\n        }\n        case \"log\": {\n          currentFrame().children.push({ type: \"log\", expression: argString });\n          break;\n        }\n        case \"meter\": {\n          currentFrame().children.push(parseMeterMacro(argString));\n          break;\n        }\n        default: {\n          currentFrame().children.push({ type: \"unknown\", name: keyword, body: argString });\n          break;\n        }\n      }\n    }\n\n    return root.children;\n  }\n\n  function parseChoiceMacro(args) {\n    const pattern = /^\"([^\"]+)\"\\s*(?:->|=>|\\|)\\s*\"([^\"]+)\"\\s*(?:\\[([^\\]]+)\\])?\\s*(?:\\{([^}]+)\\})?$/;\n    const match = args.match(pattern);\n    if (!match) {\n      return { type: \"unknown\", name: \"choice\", body: args };\n    }\n    return {\n      type: \"choice\",\n      textExpr: JSON.stringify(match[1]),\n      targetExpr: JSON.stringify(match[2]),\n      condition: match[3] || null,\n      action: match[4] || null\n    };\n  }\n\n  function parseTimerMacro(args) {\n    const pattern = /^(.+?)(?:->|\\|)\\s*\"([^\"]+)\"\\s*(?:\\{([^}]+)\\})?$/;\n    const match = args.match(pattern);\n    if (!match) {\n      return { type: \"unknown\", name: \"timer\", body: args };\n    }\n    return {\n      type: \"timer\",\n      delay: match[1].trim(),\n      targetExpr: JSON.stringify(match[2]),\n      action: match[3] || null\n    };\n  }\n\n  function parseMeterMacro(args) {\n    const options = {};\n    const regex = /(\\w+):(\"[^\"]*\"|'[^']*'|\\S+)/g;\n    let match;\n    while ((match = regex.exec(args)) !== null) {\n      const key = match[1];\n      let value = match[2];\n      if ((value.startsWith('\"') && value.endsWith('\"')) || (value.startsWith(\"'\") && value.endsWith(\"'\"))) {\n        value = value.slice(1, -1);\n        options[key] = JSON.stringify(value);\n      } else {\n        options[key] = value;\n      }\n    }\n    if (!options.value) {\n      options.value = args || \"0\";\n    }\n    return {\n      type: \"meter\",\n      options\n    };\n  }\n\n  function compilePassage(element) {\n    const name = element.getAttribute(\"name\");\n    const tags = (element.getAttribute(\"tags\") || \"\")\n      .split(/\\s+/)\n      .map(tag => tag.trim())\n      .filter(Boolean);\n    let metadata = {};\n    const metadataRaw = element.getAttribute(\"metadata\");\n    if (metadataRaw) {\n      try {\n        metadata = JSON.parse(metadataRaw);\n      } catch (error) {\n        pushLog(`\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0440\u0430\u0437\u043e\u0431\u0440\u0430\u0442\u044c metadata \u0434\u043b\u044f ${name}: ${error.message}`);\n      }\n    }\n    const source = element.textContent || \"\";\n    const tokens = tokenize(source);\n    const tree = parseTokens(tokens);\n    const links = extractLinks(source);\n    return {\n      name,\n      tags,\n      metadata,\n      source,\n      tree,\n      links\n    };\n  }\n\n  function extractLinks(content) {\n    const pattern = /\\[\\[(.+?)\\]\\]/g;\n    const result = new Set();\n    let match;\n    while ((match = pattern.exec(content)) !== null) {\n      const inner = match[1];\n      if (inner.includes(\"->\")) {\n        result.add(inner.split(\"->\").pop().trim());\n      } else if (inner.includes(\"|\")) {\n        result.add(inner.split(\"|\").pop().trim());\n      } else {\n        result.add(inner.trim());\n      }\n    }\n    return Array.from(result);\n  }\n\n  compiledPassages = new Map(rawPassages.map(p => {\n    const compiled = compilePassage(p);\n    return [compiled.name, compiled];\n  }));\n\n  storyElement.remove();\n\n  const pendingTimers = [];\n  let activeTimers = [];\n\n  function clearTimers() {\n    activeTimers.forEach(id => clearTimeout(id));\n    activeTimers = [];\n    pendingTimers.length = 0;\n  }\n\n  function addHistoryEntry(passage) {\n    const entry = {\n      name: passage.name,\n      tags: passage.tags.slice(),\n      timestamp: Date.now(),\n      notes: []\n    };\n    state.history.push(entry);\n    if (state.history.length > 400) {\n      state.history.shift();\n    }\n    renderHistoryPanel();\n    schedulePersist();\n  }\n\n  function registerNote(text) {\n    if (!state.history.length) {\n      return;\n    }\n    const entry = state.history[state.history.length - 1];\n    entry.notes.push({\n      text: safeString(text),\n      timestamp: Date.now()\n    });\n    renderHistoryPanel();\n    schedulePersist();\n  }\n\n  function transformForStatement(expression) {\n    return expression\n      .replace(/\\bis not\\b/gi, \" != \")\n      .replace(/\\bis\\b/gi, \" = \")\n      .replace(/\\bto\\b/gi, \" = \")\n      .replace(/\\band\\b/gi, \" && \")\n      .replace(/\\bor\\b/gi, \" || \");\n  }\n\n  function transformForExpression(expression) {\n    return expression\n      .replace(/\\bis not\\b/gi, \" !== \")\n      .replace(/\\bis\\b/gi, \" === \")\n      .replace(/\\band\\b/gi, \" && \")\n      .replace(/\\bor\\b/gi, \" || \");\n  }\n\n  function executeCode(code, locals = {}) {\n    if (!code) {\n      return;\n    }\n    const statement = transformForStatement(code);\n    try {\n      const fn = new Function(\"state\", \"locals\", \"util\", \"vars\", `with(util){with(vars){with(locals){${statement};}}}`);\n      fn(state, locals, util, varsProxy);\n    } catch (error) {\n      pushLog(`\u041e\u0448\u0438\u0431\u043a\u0430 \u0432 \u0432\u044b\u0440\u0430\u0436\u0435\u043d\u0438\u0438: ${error.message}`);\n    }\n  }\n\n  function evaluateExpression(expression, locals = {}) {\n    if (!expression) {\n      return \"\";\n    }\n    const prepared = transformForExpression(expression);\n    try {\n      const fn = new Function(\"state\", \"locals\", \"util\", \"vars\", `with(util){with(vars){with(locals){return (${prepared});}}}`);\n      return fn(state, locals, util, varsProxy);\n    } catch (error) {\n      pushLog(`\u041e\u0448\u0438\u0431\u043a\u0430 \u0432\u044b\u0447\u0438\u0441\u043b\u0435\u043d\u0438\u044f \u0432\u044b\u0440\u0430\u0436\u0435\u043d\u0438\u044f \"${expression}\": ${error.message}`);\n      return \"\";\n    }\n  }\n\n  function interpolate(text, locals) {\n    return text.replace(/\\{\\{([^}]+)\\}\\}/g, (_, expr) => escapeHtml(safeString(evaluateExpression(expr.trim(), locals))));\n  }\n\n  function formatText(text, locals) {\n    if (!text) {\n      return \"\";\n    }\n    let output = interpolate(text, locals);\n    output = escapeHtml(output);\n    output = output\n      .replace(/\\*\\*([^*]+)\\*\\*/g, \"<strong>$1</strong>\")\n      .replace(/__([^_]+)__/g, \"<span style=\\\"text-decoration:underline\\\">$1</span>\")\n      .replace(/~~([^~]+)~~/g, \"<del>$1</del>\")\n      .replace(/`([^`]+)`/g, \"<code>$1</code>\")\n      .replace(/\\/\\/([^/]+)\\/\\//g, \"<em>$1</em>\");\n    output = output.replace(/\\[\\[(.+?)\\]\\]/g, (_, inner) => buildLink(inner.trim(), locals));\n    const paragraphs = output.split(/\\n{2,}/).map(block => `<p>${block.replace(/\\n/g, \"<br>\")}</p>`);\n    return paragraphs.join(\"\");\n  }\n\n  function buildLink(inner, locals) {\n    let text = inner;\n    let target = inner;\n    if (inner.includes(\"->\")) {\n      const [left, right] = inner.split(\"->\");\n      text = left.trim();\n      target = right.trim();\n    } else if (inner.includes(\"|\")) {\n      const [left, right] = inner.split(\"|\");\n      text = left.trim();\n      target = right.trim();\n    }\n    const resolvedText = safeString(evaluateExpression(JSON.stringify(text), locals));\n    const resolvedTarget = safeString(evaluateExpression(JSON.stringify(target), locals));\n    return `<a href=\"#\" class=\"nw-link\" data-target=\"${escapeAttribute(resolvedTarget)}\">${escapeHtml(resolvedText)}</a>`;\n  }\n\n  function renderNodes(nodes, locals = Object.create(null), depth = 0) {\n    let html = \"\";\n    for (const node of nodes) {\n      switch (node.type) {\n        case \"text\":\n          html += formatText(node.value, locals);\n          break;\n        case \"set\":\n          executeCode(node.code, locals);\n          break;\n        case \"print\": {\n          const value = safeString(evaluateExpression(node.expression, locals));\n          html += escapeHtml(value);\n          break;\n        }\n        case \"if\": {\n          for (const branch of node.branches) {\n            if (branch.condition === null || evaluateExpression(branch.condition, locals)) {\n              html += renderNodes(branch.children, locals, depth + 1);\n              break;\n            }\n          }\n          break;\n        }\n        case \"for\": {\n          const variable = node.variable || \"$item\";\n          const collection = evaluateExpression(node.expression, locals);\n          if (Array.isArray(collection)) {\n            collection.forEach((value, index) => {\n              const loopLocals = Object.create(locals);\n              loopLocals[variable] = value;\n              loopLocals.$index = index;\n              loopLocals.$length = collection.length;\n              html += renderNodes(node.children, loopLocals, depth + 1);\n            });\n          } else if (collection && typeof collection === \"object\") {\n            Object.keys(collection).forEach((key, index) => {\n              const loopLocals = Object.create(locals);\n              loopLocals[variable] = collection[key];\n              loopLocals.$key = key;\n              loopLocals.$value = collection[key];\n              loopLocals.$index = index;\n              html += renderNodes(node.children, loopLocals, depth + 1);\n            });\n          }\n          break;\n        }\n        case \"display\": {\n          const targetName = safeString(evaluateExpression(node.target, locals));\n          html += renderPassageContent(targetName, locals, depth + 1);\n          break;\n        }\n        case \"choice\": {\n          const show = node.condition ? Boolean(evaluateExpression(node.condition, locals)) : true;\n          if (!show) {\n            break;\n          }\n          const text = safeString(evaluateExpression(node.textExpr, locals));\n          const target = safeString(evaluateExpression(node.targetExpr, locals));\n          const data = [`data-target=\"${escapeAttribute(target)}\"`];\n          if (node.action) {\n            data.push(`data-action=\"${escapeAttribute(encodeURIComponent(node.action))}\"`);\n          }\n          html += `<button class=\"nw-choice\" ${data.join(\" \")}>${escapeHtml(text)}</button>`;\n          break;\n        }\n        case \"timer\": {\n          const delay = Number(evaluateExpression(node.delay, locals)) * 1000;\n          const target = safeString(evaluateExpression(node.targetExpr, locals));\n          const snapshot = cloneLocals(locals);\n          pendingTimers.push({\n            delay: Number.isFinite(delay) ? Math.max(0, delay) : 0,\n            target,\n            action: node.action,\n            locals: snapshot\n          });\n          break;\n        }\n        case \"remember\": {\n          const message = safeString(evaluateExpression(node.expression, locals));\n          if (message) {\n            registerNote(message);\n          }\n          break;\n        }\n        case \"log\": {\n          const message = safeString(evaluateExpression(node.expression, locals));\n          if (message) {\n            pushLog(message);\n          }\n          break;\n        }\n        case \"meter\": {\n          html += renderMeter(node.options, locals);\n          break;\n        }\n        case \"unknown\": {\n          pushLog(`\u041d\u0435\u0438\u0437\u0432\u0435\u0441\u0442\u043d\u044b\u0439 \u043c\u0430\u043a\u0440\u043e\u0441 <<${node.name}>>`);\n          break;\n        }\n        default:\n          break;\n      }\n    }\n    return html;\n  }\n\n  function renderMeter(options, locals) {\n    const valueExpr = options.value || \"0\";\n    const labelExpr = options.label || null;\n    const minExpr = options.min || \"0\";\n    const maxExpr = options.max || \"100\";\n    const accentExpr = options.accent || null;\n    const value = Number(evaluateExpression(valueExpr, locals));\n    const min = Number(evaluateExpression(minExpr, locals));\n    const max = Number(evaluateExpression(maxExpr, locals));\n    const clamped = util.clamp(Number.isFinite(value) ? value : 0, Number.isFinite(min) ? min : 0, Number.isFinite(max) ? max : 100);\n    const percent = max === min ? 0 : ((clamped - min) / (max - min)) * 100;\n    const label = labelExpr ? safeString(evaluateExpression(labelExpr, locals)) : null;\n    const accent = accentExpr ? safeString(evaluateExpression(accentExpr, locals)) : null;\n    const style = accent ? ` style=\"--nw-meter-accent:${escapeAttribute(accent)}\"` : \"\";\n    return `<div class=\"nw-meter\"${style}><div class=\"nw-meter-label\"><span>${label ? escapeHtml(label) : \"\"}</span><span>${clamped}/${max}</span></div><div class=\"nw-meter-bar\"><span class=\"nw-meter-fill\" style=\"width:${Math.max(0, Math.min(100, percent)).toFixed(2)}%\"></span></div></div>`;\n  }\n\n  function renderPassageContent(name, locals = Object.create(null), depth = 0) {\n    if (depth > 12) {\n      return `<div class=\"nw-warning\">\u0421\u043b\u0438\u0448\u043a\u043e\u043c \u0433\u043b\u0443\u0431\u043e\u043a\u0430\u044f \u0432\u043b\u043e\u0436\u0435\u043d\u043d\u043e\u0441\u0442\u044c \u0432\u044b\u0432\u043e\u0434\u0430 \u0434\u043b\u044f ${escapeHtml(name)}.</div>`;\n    }\n    const passage = compiledPassages.get(name);\n    if (!passage) {\n      pushLog(`\u041f\u0435\u0440\u0435\u0445\u043e\u0434 \u043a \u043d\u0435\u0438\u0437\u0432\u0435\u0441\u0442\u043d\u043e\u043c\u0443 \u043f\u0430\u0441\u0441\u0430\u0436\u0443 ${name}`);\n      return `<div class=\"nw-warning\">\u041f\u0430\u0441\u0441\u0430\u0436 \"${escapeHtml(name)}\" \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d.</div>`;\n    }\n    return renderNodes(passage.tree, locals, depth + 1);\n  }\n\n  function attachInteractiveHandlers() {\n    main.querySelectorAll('[data-target]').forEach(element => {\n      element.addEventListener('click', event => {\n        event.preventDefault();\n        const target = element.getAttribute('data-target');\n        const action = element.getAttribute('data-action');\n        if (action) {\n          executeCode(decodeURIComponent(action));\n        }\n        if (target) {\n          showPassage(target);\n        }\n      });\n    });\n  }\n\n  function updatePalette(metadata) {\n    if (!metadata || typeof metadata.palette !== 'object') {\n      paletteKeys.forEach(key => {\n        document.documentElement.style.removeProperty(`--nw-${key}`);\n      });\n      paletteKeys.clear();\n      return;\n    }\n    const entries = Object.entries(metadata.palette);\n    paletteKeys.forEach(key => {\n      document.documentElement.style.removeProperty(`--nw-${key}`);\n    });\n    paletteKeys = new Set(entries.map(([key]) => key));\n    entries.forEach(([key, value]) => {\n      document.documentElement.style.setProperty(`--nw-${key}`, value);\n    });\n  }\n\n  function applyPassageAtmosphere(passage) {\n    if (passage.tags.length) {\n      document.body.setAttribute('data-passage-tags', passage.tags.join(' '));\n    } else {\n      document.body.removeAttribute('data-passage-tags');\n    }\n    updatePalette(passage.metadata);\n  }\n\n  function showPassage(name, options = {}) {\n    const passage = compiledPassages.get(name);\n    if (!passage) {\n      pushLog(`\u041f\u043e\u043f\u044b\u0442\u043a\u0430 \u043e\u0442\u043a\u0440\u044b\u0442\u044c \u043d\u0435\u0438\u0437\u0432\u0435\u0441\u0442\u043d\u044b\u0439 \u043f\u0430\u0441\u0441\u0430\u0436 \"${name}\"`);\n      main.innerHTML = `<article class=\"nw-passage\"><div class=\"nw-warning\">\u041f\u0430\u0441\u0441\u0430\u0436 \"${escapeHtml(name)}\" \u043d\u0435 \u043d\u0430\u0439\u0434\u0435\u043d.</div></article>`;\n      return;\n    }\n\n    clearTimers();\n    state.current = name;\n    applyPassageAtmosphere(passage);\n    const content = renderPassageContent(name);\n    main.innerHTML = `<article class=\"nw-passage\" data-passage=\"${escapeAttribute(name)}\">${content}</article>`;\n    attachInteractiveHandlers();\n    runPendingTimers();\n    if (!options.silent) {\n      addHistoryEntry(passage);\n      pushLog(`\u041e\u0442\u043a\u0440\u044b\u0442 \u043f\u0430\u0441\u0441\u0430\u0436 \"${name}\"`);\n    }\n    schedulePersist();\n  }\n\n  function runPendingTimers() {\n    pendingTimers.forEach(timer => {\n      const id = setTimeout(() => {\n        if (timer.action) {\n          executeCode(timer.action, timer.locals);\n        }\n        showPassage(timer.target);\n      }, timer.delay);\n      activeTimers.push(id);\n    });\n    pendingTimers.length = 0;\n  }\n\n  function renderHistoryPanel() {\n    if (!historyContainer) {\n      return;\n    }\n    if (!state.history.length) {\n      historyContainer.innerHTML = '<p class=\"nw-empty\">\u0418\u0441\u0442\u043e\u0440\u0438\u044f \u0435\u0449\u0451 \u043d\u0435 \u0437\u0430\u043f\u0438\u0441\u0430\u043d\u0430.</p>';\n      return;\n    }\n    historyContainer.innerHTML = state.history\n      .map(entry => {\n        const timestamp = new Date(entry.timestamp);\n        const tags = entry.tags.length ? `<div>${entry.tags.map(tag => `<span class=\"nw-tag\">#${escapeHtml(tag)}</span>`).join('')}</div>` : '';\n        const notes = entry.notes.map(note => `<div class=\"nw-note\">${escapeHtml(note.text)} <time>${escapeHtml(util.time(note.timestamp))}</time></div>`).join('');\n        return `<article class=\"nw-history-entry\"><header><strong>${escapeHtml(entry.name)}</strong> \u00b7 <time>${escapeHtml(timestamp.toLocaleString())}</time></header>${tags}${notes}</article>`;\n      })\n      .join('');\n  }\n\n  function renderStatePanel() {\n    if (!stateContainer) {\n      return;\n    }\n    const keys = Object.keys(rawVars).sort();\n    if (!keys.length) {\n      stateContainer.innerHTML = '<p class=\"nw-empty\">\u041f\u0435\u0440\u0435\u043c\u0435\u043d\u043d\u044b\u0435 \u043d\u0435 \u0443\u0441\u0442\u0430\u043d\u043e\u0432\u043b\u0435\u043d\u044b.</p>';\n      return;\n    }\n    stateContainer.innerHTML = keys\n      .map(key => `<div class=\"nw-state-entry\"><span>${escapeHtml(key)}</span><span>${escapeHtml(JSON.stringify(rawVars[key]))}</span></div>`)\n      .join('');\n  }\n\n  function snapshotVars() {\n    const plain = {};\n    Object.keys(rawVars).forEach(key => {\n      plain[key] = rawVars[key];\n    });\n    return plain;\n  }\n\n  function serializeState() {\n    return {\n      vars: snapshotVars(),\n      history: state.history,\n      current: state.current,\n      timestamp: Date.now()\n    };\n  }\n\n  function persistState() {\n    try {\n      const snapshot = serializeState();\n      localStorage.setItem(storageKey, JSON.stringify(snapshot));\n    } catch (error) {\n      pushLog(`\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0441\u043e\u0445\u0440\u0430\u043d\u0438\u0442\u044c \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u0435: ${error.message}`);\n    }\n  }\n\n  function loadState() {\n    try {\n      const raw = localStorage.getItem(storageKey);\n      if (!raw) {\n        return null;\n      }\n      return JSON.parse(raw);\n    } catch (error) {\n      pushLog(`\u041d\u0435 \u0443\u0434\u0430\u043b\u043e\u0441\u044c \u0437\u0430\u0433\u0440\u0443\u0437\u0438\u0442\u044c \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u0435: ${error.message}`);\n      return null;\n    }\n  }\n\n  function restoreState(snapshot) {\n    if (!snapshot) {\n      return false;\n    }\n    Object.keys(rawVars).forEach(key => delete rawVars[key]);\n    Object.assign(rawVars, snapshot.vars || {});\n    state.history = Array.isArray(snapshot.history) ? snapshot.history : [];\n    state.current = snapshot.current || null;\n    renderStatePanel();\n    renderHistoryPanel();\n    return true;\n  }\n\n  function resetState() {\n    Object.keys(rawVars).forEach(key => delete rawVars[key]);\n    state.history = [];\n    state.current = null;\n    renderStatePanel();\n    renderHistoryPanel();\n    persistState();\n  }\n\n  function activatePanel(name) {\n    app.querySelectorAll('.nw-button[data-panel]').forEach(button => {\n      const active = button.getAttribute('data-panel') === name;\n      button.setAttribute('data-active', active ? 'true' : 'false');\n    });\n    app.querySelectorAll('.nw-panel').forEach(panel => {\n      const match = panel.getAttribute('data-panel-name') === name;\n      panel.hidden = !match;\n    });\n  }\n\n  app.querySelectorAll('.nw-button[data-panel]').forEach(button => {\n    button.addEventListener('click', () => {\n      const panelName = button.getAttribute('data-panel');\n      const isActive = button.getAttribute('data-active') === 'true';\n      activatePanel(isActive ? '' : panelName);\n      if (!isActive) {\n        renderStatePanel();\n        renderHistoryPanel();\n        renderLog();\n      }\n    });\n  });\n\n  const restartButton = app.querySelector('.nw-button[data-action=\"restart\"]');\n  if (restartButton) {\n    restartButton.addEventListener('click', () => {\n      if (confirm('\u0421\u0431\u0440\u043e\u0441\u0438\u0442\u044c \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u0435 \u0438\u0441\u0442\u043e\u0440\u0438\u0438?')) {\n        clearTimers();\n        resetState();\n        localStorage.removeItem(storageKey);\n        showPassage(startPassageName, { silent: true });\n        addHistoryEntry(compiledPassages.get(startPassageName));\n        pushLog('\u0418\u0441\u0442\u043e\u0440\u0438\u044f \u043f\u0435\u0440\u0435\u0437\u0430\u043f\u0443\u0449\u0435\u043d\u0430.');\n      }\n    });\n  }\n\n  window.addEventListener('keydown', event => {\n    if ((event.ctrlKey || event.metaKey) && event.key.toLowerCase() === 's') {\n      event.preventDefault();\n      persistState();\n      pushLog('\u0421\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u0435 \u0441\u043e\u0445\u0440\u0430\u043d\u0435\u043d\u043e \u0432\u0440\u0443\u0447\u043d\u0443\u044e.');\n    }\n  });\n\n  const savedState = loadState();\n  let initialPassage = startPassageName;\n  if (savedState && restoreState(savedState) && savedState.current && compiledPassages.has(savedState.current)) {\n    initialPassage = savedState.current;\n    pushLog('\u0417\u0430\u0433\u0440\u0443\u0436\u0435\u043d\u043e \u0441\u043e\u0445\u0440\u0430\u043d\u0451\u043d\u043d\u043e\u0435 \u0441\u043e\u0441\u0442\u043e\u044f\u043d\u0438\u0435.');\n  }\n\n  loader.remove();\n  app.hidden = false;\n  app.focus?.();\n\n  showPassage(initialPassage, { silent: true });\n  addHistoryEntry(compiledPassages.get(initialPassage));\n  pushLog(`\u0418\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0438\u0440\u043e\u0432\u0430\u043d\u043e ${formatName} ${formatVersion}.`);\n\n  window.NovaWeave = Object.freeze({\n    version: \"1.0.0\",\n    state,\n    show: showPassage,\n    evaluate: expression => evaluateExpression(expression),\n    util\n  });\n})();\n</script>\n<script id=\"story-user-script\">\n{{STORY_JAVASCRIPT}}\n</script>\n</body>\n</html>"
});
